---
title: '"Adherència" basat en registres clínics'
author: "Jordi Real. USR-BCN "
date: "13/2/2020"
output: ioslides_presentation
logo: "logoIDIAP.png"
font_adjustment: -3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = F)

library(ggplot2)
library(dplyr)



```


```{r carregar_dades, include=FALSE}


load(here::here("dades","adherence_data.Rdata"))

link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

```


```{r funcions, include=FALSE}
# Funció per generar mapes

# Selecciona un id i retorna diagrama de temps, la MPR i adehrencia

generar_mapa<-function(gap=1,set_seed=9) {
# gap<-0 # gap: gap=45
# set_seed<-3  # set_seed=12

# 0. Mostrejar id's  
  set.seed(set_seed)

  prescrits_id<-dt_prescrits %>% semi_join(dt_ids %>% sample_n(1),by="idp")
  facturats_id<-dt_facturats %>% semi_join(prescrits_id,by="idp")

# 2.agregar solapaments tant de prescrits com facturats
  prescrits_id<-agregar_solapaments_gaps(dt=prescrits_id,id="idp",datainici =
                                           "dat",datafinal = "dbaixa",gap=gap)
  facturats_id<-facturats_id %>%
    mutate(dat=lubridate::ymd(paste0(as.character(dat),"15")),dbaixa=dat+(30*env)) %>%
    agregar_solapaments_gaps(id="idp",datainici = "dat",datafinal = "dbaixa",gap=gap)
# 2.2. Juntar prescrits + dispensats
  total_id<-mutate(prescrits_id,tipus="Prescrit") %>%
    rbind(mutate(facturats_id,tipus="Dispensat"))
  total_id<-total_id %>% unite(id_kk,c(idp,tipus),remove = F)
# Mapejar
  mapa<-MAP_ggplot(dades=total_id,datainicial = "dat",datafinal =
                     "dbaixa",id="id_kk",grup_linea = "tipus",grup_color = "tipus") 

# sumar temps acumulats
  temps_per_id<-total_id %>% mutate(temps=dbaixa-dat) %>% group_by(idp,tipus) %>%
    summarise(Temps=sum(temps))
# Generar taulaMPR

  # Si no existeix dispensat = 0
  temps_dispensat<-temps_per_id$Temps[1] %>% as.numeric()
  temps_prescrit<-temps_per_id$Temps[2] %>% as.numeric()
  
  if (is.na(temps_prescrit)) {
    temps_prescrit<-temps_dispensat
    temps_dispensat<-0}
  
  tableMPR<-temps_dispensat/temps_prescrit %>% 
    as_tibble() %>% 
    select(MPR=value) 
# 3. Posar-ho en una taula
  tableMPR<-tableMPR %>% 
    mutate(D=temps_dispensat,
           P=temps_prescrit,
         Adherence=if_else(MPR>0.8,"Good: >=0.8","Low: <0.8")) %>% 
    transmute(D,P,MPR=round(MPR,3),Adherence)

subtitul<-paste0("MPR: ",round(tableMPR$MPR,3)," del subjecte: ",total_id$idp[1])


mapa+labs(x="Temps", 
              y="Subjecte",
              title="Seguiment fàrmacs",
              subtitle=subtitul)+
  annotation_custom(gridExtra::tableGrob(tableMPR))

}


```

## Guió

<left>

- Met+

- "Adherència" & MPR

- Quines dades disposem?

- Exemples gràfics

- Preprocessament de dades 

- Mapes temporals

- IdMaps

- Análisis i limitacions

</left>

## Estudi Met+ {.smaller}

- 3 grups DM2 amb inici d'antidiabetics: Sulfonilurea, IDPP-4 o un iSGLT2. 

- Tractats amb metformina previa i insuficient control glucémic.

- Objectius: Avaluar   

    - Principal: Canvis en HbA1c i pes després de l'addició (Fins 24 mesos)

    - Secundari 1....
    
    - ....
    
    - ....
    
    - ....

    - Secundari 5: Adherencia al tratament per cada grup

    - Secundari 6: Suspensions / abandons del tractament (persistencia al tratactamen)


## Taxa de possessió de medicament (MPR) {.smaller}

- The therapeutic adherence will be assessed through pharmacy invoice data (drug dispensing)

- For each patient will be calculated The medication possession ratio (MPR)

<center> 
$MPR = \frac{TempsDispensació(D)} {TempsTranscorregut(P)}$ 
</center>

On: 

- D: Temps de dispensat ("real) del farmac d'estudi

- P: Temps prescrit ("teoric") durant periode de seguiment o fins la prematura finalització

## Adherència {.smaller}

<center> 
 $MPR = \frac{f(D) } { f(P)} \in [0-1]$, 

<font size="4"> on D= Dispensació acumulada, i P = Periode de prescripció </font>

</center> 

| Adherença |  Criteri      |
|:---------:+:-------------:|
| Good      |$MPR \ge 0.8$  |
| Low       |$MPR < 0.8$    |

<br />
> Característiques / Assumpcions: 

    - Si D=0 --> MPR=0 
    - Dispensació va vinculada a una prescripció. Per tant s'ha de complir:
    
  $D \le P$ <br/> 
  $D \in P$ <br/>
  -Si D (observada) > P (observada)  -> MPR=1 
  
## Exemples

> Tractament dispensat i prescrit (Dades)

```{r mostrardades}
# Selecciono un identificador
prescrits_id<-dt_prescrits %>% filter(idp=="acba786c")

facturats_id<-dt_facturats %>% semi_join(prescrits_id,by="idp")

kable(prescrits_id, caption = "Historic de farmacs prescrits") %>% kableExtra::kable_styling()
kable(facturats_id, caption = "Historic de farmacs dispensats") %>% kableExtra::kable_styling()

```

## Exemple 1 gràfic

> 1. Dispensació i Prescripció

```{r, message=FALSE,echo=F,results = 'hide'}
# Global
generar_mapa(gap=0,set_seed=10)
```

## Exemple 2 gràfic

> 2. No consta dispensació

```{r, message=FALSE,echo=F,results = 'hide'}
# No consta dispensació
generar_mapa(gap=0,set_seed=3)

```

## Exemple 3 gràfic

> 2. Inici de dispensació previa a la prescripció

```{r, message=FALSE,echo=F,results = 'hide'}
# Inici de dispensació previa a la prescripció
generar_mapa(gap=0,set_seed=25)

```

## Exemple 4 gràfic

> Dispensació = Prescripció 

```{r, message=FALSE,echo=F,results = 'hide'}
# Igual dispesació = P 
generar_mapa(gap=0,set_seed=41)

```

## Exemple gràfic

> Més dispensació que prescripció

```{r, message=FALSE,echo=F,results = 'hide'}
# Més dispensació que prescripció
generar_mapa(gap=45,set_seed=55)


```


## Quines dades disposem? {.smaller}

> Historic de prescripcions (2 pacients)

```{r dades, echo=F, message=FALSE}
prescrits_id<-mostreig_ids(dt=dt_prescrits,id="idp",set_seed=11,n_mostra = 1)
kable(prescrits_id) %>% kableExtra::kable_styling()

prescrits_id<-mostreig_ids(dt=dt_prescrits,id="idp",set_seed=10,n_mostra = 1)
kable(prescrits_id) %>% kableExtra::kable_styling()

```


## Mapa temporal de prescripcions

> Prescripció SU (n=1)

```{r, fig1, fig.asp=0.5}


MAP_ggplot(dades=prescrits_id,datainicial = "dat",datafinal = "dbaixa",
            id="idp",grup_color = "cod")



```

## Mapa temporal de prescripcions

> Prescripció SU (n=10) per ATC

```{r, fig2, fig.asp=0.5,echo=F}
prescrits_id<-dt_prescrits %>% 
  filter(agr=="SU") %>%
  mostreig_ids(id="idp",set_seed=101,n_mostra = 10)

MAP_ggplot(dades=prescrits_id,datainicial = "dat",datafinal = "dbaixa",
            id="idp",grup_color = "cod")
```


## Mapa temporal de prescripcions

> 10 pacients amb prescripcions Sulfonorea

```{r, fig3, fig.asp=0.50,echo=F}

MAP_ggplot(dades=prescrits_id,datainicial = "dat",datafinal = "dbaixa",
            id="idp",grup_color = "agr")

```


## Mapa temporal de prescripcions

> Prescripcions de Sulfonorea després d'eliminar solapaments

```{r, fig.asp=0.5, echo=F, include=F}
prescrits_id<-agregar_solapaments_gaps(dt=prescrits_id,id="idp",datainici = "dat",datafinal = "dbaixa",gap=45)

```


```{r, fig.asp=0.5, echo=F}

MAP_ggplot(dades=prescrits_id,datainicial = "dat",datafinal = "dbaixa",
        id="idp")

```

## Mapa temporal de prescripcions

> Temps de seguiment màxim a 24 mesos

```{r, fig.asp=0.5, echo=F, include=F}
prescrits_id<-agregar_solapaments_gaps(dt=prescrits_id,id="idp",datainici = "dat",datafinal = "dbaixa",gap=45)
prescrits_id<-prescrits_id %>% left_join(dt_metplus)
```

```{r, fig.asp=0.5, echo=F}
MAP_ggplot(dades=prescrits_id,datainicial = "dat",datafinal = "datafiOT",id="idp")

```


## Dispensacions (Que tenim?) {.smaller}

> Mostra d'historic de dispensacions


```{r, message=FALSE }
facturats_id<-dt_facturats %>% inner_join(prescrits_id %>% distinct(idp)) %>% filter(agr=="SU")

kable(facturats_id %>% head(10)) %>% kableExtra::kable_styling() 

```

## Mapa temporal de dispensacions

> 10 pacients amb prescripcions de Sulfonorea

```{r, fig.asp=0.50,echo=F}

# Genero datafi # 
facturats_id<-facturats_id %>% 
  mutate(dat=lubridate::ymd(paste0(as.character(dat),"15")),datafi=dat+(30*env))

MAP_ggplot(dades=facturats_id,datainicial = "dat",datafinal = "datafi",
            id="idp",grup_color = "cod")

```


## Mapa temporal de dispensacions

> Aplicant factor de conversió

```{r, fig.asp=0.50,echo=F, warning = FALSE}

conductor_facmacs<-read_excel(here::here("dades","cataleg_met.xls"),col_types = "text") %>% 
  select(cod,factor_conversio_farmacs) %>% filter(!is.na(factor_conversio_farmacs)) %>% unique()

# Factor de conversió en funció de DDD 
facturats_id<-facturats_id %>% 
  dplyr::left_join(conductor_facmacs, by="cod") %>% 
  mutate(env=env*as.numeric(factor_conversio_farmacs)) %>% 
  select(-factor_conversio_farmacs) 

# Genero datafi en funció dels envasos # 
facturats_id<-facturats_id %>%  mutate(datafi=dat+(30*env)) 

MAP_ggplot(dades=facturats_id,datainicial = "dat",datafinal = "datafi",
            id="idp",grup_color = "cod")

```

## Mapa temporal de dispensacions

> Eliminar discontinuitats i solapaments

```{r, fig.asp=0.50,echo=F, warning = FALSE,results = 'hide'}

facturats_id<-facturats_id %>% filter(agr=="SU")

facturats_id<-agregar_solapaments_gaps(dt=facturats_id,id="idp",datainici = "dat",datafinal = "datafi",gap=92)
  
MAP_ggplot(dades=facturats_id,datainicial = "dat",datafinal = "datafi",
            id="idp")

```

## Mapa temporal de dispensacions

> Finestra temporal inferior o igual a 24 mesos

```{r, fig.asp=0.50,echo=F, warning = FALSE}
facturats_id<-facturats_id %>% left_join(dt_metplus,by="idp")


MAP_ggplot(dades=facturats_id,datainicial = "dat",datafinal = "datafiOT",id="idp")
```

## Aplicació Shiny per mapejar registres clínics (IdMaps)

> [IdMaps](https://www.shinyapps.io/admin/#/dashboard): Eina per visualitzar dades longitudinals


> Utilitats: 

- Validar i controlar processos

- Visualitzar historics (longitudinals)

- Ajuda planificar indicadors


> Parametres (SU, llavor=114, n=10)


## Analisis de dades

- Analisis Sota tractament (On treatment)

- Definir finalització de tractament dispensat (+3 mesos)

- Limitacions: 

    - Afecta al temps de seguiment i missings:
    - Reducceix el temps de seguiment 
    - Variables continues pot haber més missings i decrement del temps promitg de la valoració 
    - En outcomes tipus esdeveniment, increment del % de censura 





