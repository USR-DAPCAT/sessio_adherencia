---
title: '"Adherència" basat en registres clínics'
author: "Jordi Real. USR-BCN "
date: "13/2/2020"
output: ioslides_presentation
logo: "logoIDIAP.png"
font_adjustment: -3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = F)

# library(cowplot)


```


```{r carregar_dades, include=FALSE}


link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

load(here::here("dades","adherence_data.Rdata"))




# dt_poblacio<-readRDS(here::here("dades","METPLUS_entregable_poblacio_20181126_190346.rds")) %>%
#   mutate(idp=stringr::str_sub(idp,1,8))
# dt_facturats<-readRDS(here::here("dades","METPLUS_entregable_farmacs_facturats_20181126_190346.rds")) %>%
#   mutate(idp=stringr::str_sub(idp,1,8))
# dt_prescrits<-readRDS(here::here("dades","METPLUS_entregable_farmacs_prescrits_20181126_190346.rds")) %>%
#   mutate(idp=stringr::str_sub(idp,1,8))
# 
# # MetPlus 
# dt_metplus<-readRDS(here::here("dades","metplus_complet.Rds")) %>%
#   mutate(idp=stringr::str_sub(idp,1,8)) %>% 
#   select(c("idp","grup","dtindex","sortida","datafiOT","datafi_seguiment","tempsTX.GRUP"))
# 
# # Filtrar per mostra només inclosos en MET+
# dt_facturats <- dt_facturats %>% semi_join(dt_metplus,by="idp")
# dt_prescrits<- dt_prescrits %>% semi_join(dt_metplus,by="idp")
# 
# # SElecciono només farmacs d'estudi
# dt_prescrits<-dt_prescrits %>% filter(agr=="IDPP4" | agr=="SU" | agr=="METplus IDPP4" | agr=="iSGLT2" | agr=="METplus ISGTL2") %>% select(idp,cod,agr,dat,dbaixa)
# 
# dt_facturats<-dt_facturats %>% filter(agr=="IDPP4" | agr=="SU" | agr=="METplus IDPP4" | agr=="iSGLT2" | agr=="METplus ISGTL2")
# 
# # Selecciono ids mostra
# dt_ids<-dt_facturats %>% distinct(idp) %>% rbind(dt_prescrits %>% distinct(idp)) %>% distinct(idp)
# dt_metplus<-dt_metplus %>% semi_join(dt_ids,by="idp")

# save.image(here::here("dades","adherence_data.Rdata"))



# Funció per generar mapes

generar_mapa<-function(gap=1,set_seed=9) {
# gap<-1 # gap: gap=45
# set_seed<-9  # set_seed=12

# 1. Mostrejar prescrits
prescrits_id<-mostreig_ids(dt=dt_prescrits,id="idp",set_seed=set_seed,n_mostra = 1)
# 1.2. Seleccionar facturats del mostrejat
facturats_id<-dt_facturats %>% semi_join(prescrits_id,by="idp")
# 2.agregar solapaments tant de prescrits com facturats 
prescrits_id<-agregar_solapaments_gaps(dt=prescrits_id,id="idp",datainici = "dat",datafinal = "dbaixa",gap=gap)
facturats_id<-facturats_id %>% mutate(dat=lubridate::ymd(paste0(as.character(dat),"15")),dbaixa=dat+(30*env)) %>% 
  agregar_solapaments_gaps(id="idp",datainici = "dat",datafinal = "dbaixa",gap=gap)
# 2.2. Juntar prescrits + dispensats
total_id<-mutate(prescrits_id,tipus="Prescrit") %>% rbind(mutate(facturats_id,tipus="Dispensat"))
total_id<-total_id %>% unite(id_kk,c(idp,tipus),remove = F)
# Mapejar
mapa<-MAP_ggplot(dades=total_id,datainicial = "dat",datafinal = "dbaixa",id="id_kk",grup_linea = "tipus",grup_color = "tipus") 

# sumar temps acumulats
temps_per_id<-total_id %>% mutate(temps=dbaixa-dat) %>% group_by(idp,tipus) %>% summarise(Temps=sum(temps))
# kable(temps_per_id, caption = "Temps acumulat de farmacs prescrits/facturat") %>% kableExtra::kable_styling()
tableMPR<-(temps_per_id$Temps[1] %>% as.numeric())/temps_per_id$Temps[2] %>% as.numeric() %>% 
  as_tibble() %>% 
  select(MPR=value) 
# 3. Posar-ho en una taula
tableMPR<-tableMPR %>% 
  mutate(D=temps_per_id$Temps[1],P=temps_per_id$Temps[2],
         Adherence=if_else(MPR>0.8,"Good: >=0.8","Low: <0.8")) %>% 
  select(D,P,MPR,Adherence)

list(plot=mapa,taula=tableMPR)
}



```

## Guió

<left>

- Met+

- "Adherencia" & MPR

- Quines dades disposem?

- Preprocessament de dades 

- Mapes temporals

- IdMaps

- Análisis i limitacions

</left>

## Estudi Met+ {.smaller}

- 3 grups DM2 amb inici d'antidiabetics: Sulfonilurea, IDPP-4 o un iSGLT2. 

- Tractats amb metformina previa i insuficient control glucémic.

- Objectius: Avaluar   

    - Principal: Canvis en HbA1c i pes després de l'addició (Fins 24 mesos)

    - **Secundaris 5: Adherencia al tratament per cada grup**

    - Secundaris 6: Suspensions / abandons del tractament (persistencia al tratactamen)


## Taxa de possessió de medicament (MPR) {.smaller}

- The therapeutic adherence will be assessed through pharmacy invoice data (drug dispensing)

- For each patient will be calculated The medication possession ratio (MPR)

<center> 
$MPR = \frac{TempsDispensació(D)} {TempsTranscorregut(P)}$ 
</center>

On: 

- D: Temps de dispensat ("real) del farmac d'estudi

- P: Temps prescrit ("teoric") durant periode de seguiment o fins la prematura finalització

## Adherenia {.smaller}

<center> 
 $MPR = \frac{f(D) } { f(P)} \in [0-1]$, 

<font size="4"> on D= Dispensació acumulada, i P = Periode de prescripció </font>

</center> 

| Adherença |  Criteri      |
|:---------:+:-------------:|
| Good      |$MPR \ge 0.8$  |
| Low       |$MPR < 0.8$    |

<br />
> Característiques / Assumpcions: 

    - Si D=0 --> MPR=0 
    - Dispensació va vinculada a una prescripció. Per tant s'ha de complir:
    
  $D \le P$ <br/> 
  $D \in P$ <br/>
  -Si D (observada) > P (observada)  -> MPR=1 
  
## Exemples
- Tractactament dispensat i prescrit

```{r, results = 'hide'}
# Parametres:
# Discontinuitat (gap=45)
gap<-1 # gap: gap=45
set_seed<-9  # set_seed=12

# Mostrejar prescrits
prescrits_id<-mostreig_ids(dt=dt_prescrits,id="idp",set_seed=set_seed,n_mostra = 1)
# kable(prescrits_id) %>% kableExtra::kable_styling()
facturats_id<-dt_facturats %>% semi_join(prescrits_id,by="idp")

kable(prescrits_id, caption = "Historic de farmacs prescrits") %>% kableExtra::kable_styling()
kable(facturats_id, caption = "Historic de farmacs dispensats") %>% kableExtra::kable_styling()

```


```{r, message=FALSE,echo=F,results = 'hide'}
# Eliminar solapaments 
prescrits_id<-agregar_solapaments_gaps(dt=prescrits_id,id="idp",datainici = "dat",datafinal = "dbaixa",gap=gap)
facturats_id<-facturats_id %>% mutate(dat=lubridate::ymd(paste0(as.character(dat),"15")),dbaixa=dat+(30*env)) %>% 
  agregar_solapaments_gaps(id="idp",datainici = "dat",datafinal = "dbaixa",gap=gap)

# Juntar prescrits + dispensats
total_id<-mutate(prescrits_id,tipus="Prescrit") %>% rbind(mutate(facturats_id,tipus="Dispensat"))
```

```{r, message=FALSE,echo=F, fig.asp=0.3}
# Format idp
total_id<-total_id %>% unite(id_kk,c(idp,tipus),remove = F)
MAP_ggplot(dades=total_id,datainicial = "dat",datafinal = "dbaixa",id="id_kk",grup_linea = "tipus",grup_color = "tipus") 

```

```{r}
temps_per_id<-total_id %>% mutate(temps=dbaixa-dat) %>% group_by(idp,tipus) %>% summarise(Temps=sum(temps))
# kable(temps_per_id, caption = "Temps acumulat de farmacs prescrits/facturat") %>% kableExtra::kable_styling()
tableMPR<-(temps_per_id$Temps[1] %>% as.numeric())/temps_per_id$Temps[2] %>% as.numeric() %>% 
  as_tibble() %>% 
  select(MPR=value) 

tableMPR<-tableMPR %>% 
  mutate(D=temps_per_id$Temps[1],P=temps_per_id$Temps[2],
  Adherence=if_else(MPR>0.8,"Good: >=0.8","Low: <0.8")) %>% 
  select(D,P,MPR,Adherence)
kable(tableMPR,digits=3)%>% kableExtra::kable_styling()
```


```{r,message=FALSE,echo=F,fig.asp=0.3,results = 'hide',include=F}
pp<-generar_mapa(gap=2,set_seed=68)
```

## Un altre exemple

```{r message=FALSE, echo=F, fig.asp=0.3, warning=FALSE}

pp$plot

```


```{r}

pp$taula %>% kable(digits=3)%>% kableExtra::kable_styling()


```


## Quines dades disposem? {.smaller}

> Historic de prescripcions (2 pacients)

```{r dades, echo=F, message=FALSE}
prescrits_id<-mostreig_ids(dt=dt_prescrits,id="idp",set_seed=11,n_mostra = 1)
kable(prescrits_id) %>% kableExtra::kable_styling()

prescrits_id<-mostreig_ids(dt=dt_prescrits,id="idp",set_seed=10,n_mostra = 1)
kable(prescrits_id) %>% kableExtra::kable_styling()

```


## Mapa temporal de prescripcions

> Prescripció SU (n=1)

```{r, fig1, fig.asp=0.5}


MAP_ggplot(dades=prescrits_id,datainicial = "dat",datafinal = "dbaixa",
            id="idp",grup_color = "cod")



```

## Mapa temporal de prescripcions

> Prescripció SU (n=10) per ATC

```{r, fig2, fig.asp=0.5,echo=F}
prescrits_id<-dt_prescrits %>% 
  filter(agr=="SU") %>%
  mostreig_ids(id="idp",set_seed=101,n_mostra = 10)

MAP_ggplot(dades=prescrits_id,datainicial = "dat",datafinal = "dbaixa",
            id="idp",grup_color = "cod")
```


## Mapa temporal de prescripcions

> 10 pacients amb prescripcions Sulfonorea

```{r, fig3, fig.asp=0.50,echo=F}

MAP_ggplot(dades=prescrits_id,datainicial = "dat",datafinal = "dbaixa",
            id="idp",grup_color = "agr")

```


## Mapa temporal de prescripcions

> Prescripcions de Sulfonorea després d'eliminar solapaments

```{r, fig.asp=0.5, echo=F, include=F}
prescrits_id<-agregar_solapaments_gaps(dt=prescrits_id,id="idp",datainici = "dat",datafinal = "dbaixa",gap=45)

```


```{r, fig.asp=0.5, echo=F}

MAP_ggplot(dades=prescrits_id,datainicial = "dat",datafinal = "dbaixa",
        id="idp")

```

## Mapa temporal de prescripcions

> Temps de seguiment màxim a 24 mesos

```{r, fig.asp=0.5, echo=F, include=F}
prescrits_id<-agregar_solapaments_gaps(dt=prescrits_id,id="idp",datainici = "dat",datafinal = "dbaixa",gap=45)
prescrits_id<-prescrits_id %>% left_join(dt_metplus)
```

```{r, fig.asp=0.5, echo=F}
MAP_ggplot(dades=prescrits_id,datainicial = "dat",datafinal = "datafiOT",id="idp")

```


## Dispensacions (Que tenim?) {.smaller}

> Mostra d'historic de dispensacions


```{r, message=FALSE }
facturats_id<-dt_facturats %>% inner_join(prescrits_id %>% distinct(idp)) %>% filter(agr=="SU")

kable(facturats_id %>% head(10)) %>% kableExtra::kable_styling() 

```

## Mapa temporal de dispensacions

> 10 pacients amb prescripcions de Sulfonorea

```{r, fig.asp=0.50,echo=F}

# Genero datafi # 
facturats_id<-facturats_id %>% 
  mutate(dat=lubridate::ymd(paste0(as.character(dat),"15")),datafi=dat+(30*env))

MAP_ggplot(dades=facturats_id,datainicial = "dat",datafinal = "datafi",
            id="idp",grup_color = "cod")

```


## Mapa temporal de dispensacions

> Aplicant factor de conversió

```{r, fig.asp=0.50,echo=F, warning = FALSE}

conductor_facmacs<-read_excel(here::here("dades","cataleg_met.xls"),col_types = "text") %>% 
  select(cod,factor_conversio_farmacs) %>% filter(!is.na(factor_conversio_farmacs)) %>% unique()

# Factor de conversió en funció de DDD 
facturats_id<-facturats_id %>% 
  dplyr::left_join(conductor_facmacs, by="cod") %>% 
  mutate(env=env*as.numeric(factor_conversio_farmacs)) %>% 
  select(-factor_conversio_farmacs) 

# Genero datafi en funció dels envasos # 
facturats_id<-facturats_id %>%  mutate(datafi=dat+(30*env)) 

MAP_ggplot(dades=facturats_id,datainicial = "dat",datafinal = "datafi",
            id="idp",grup_color = "cod")

```

## Mapa temporal de dispensacions

> Eliminar discontinuitats i solapaments

```{r, fig.asp=0.50,echo=F, warning = FALSE,results = 'hide'}

facturats_id<-facturats_id %>% filter(agr=="SU")

facturats_id<-agregar_solapaments_gaps(dt=facturats_id,id="idp",datainici = "dat",datafinal = "datafi",gap=92)
  
MAP_ggplot(dades=facturats_id,datainicial = "dat",datafinal = "datafi",
            id="idp")

```

## Mapa temporal de dispensacions

> Finestra temporal inferior o igual a 24 mesos

```{r, fig.asp=0.50,echo=F, warning = FALSE}
facturats_id<-facturats_id %>% left_join(dt_metplus,by="idp")


MAP_ggplot(dades=facturats_id,datainicial = "dat",datafinal = "datafiOT",id="idp")
```

## Aplicació Shiny per mapejar registres clínics (IdMaps)

> [IdMaps](https://www.shinyapps.io/admin/#/dashboard): Eina per visualitzar dades longitudinals


> Utilitats: 

- Validar i controlar processos

- Visualitzar historics (longitudinals)

- Ajuda planificar indicadors i a determinar paràmetres


> Parametres (SU, llavor=114, n=10)


## Analisis de dades

- Analisis Sota tractament (On treatment)

- Definir finalització de tractament dispensat (+3 mesos)

- Afecta al temps de seguiment i missings:

    - Reducció del temps de seguiment 
    - Variables continues pot haber més missings i decrement del temps promitg de la valoració 
    - En outcomes tipus esdeveniment, increment del % de censura 





